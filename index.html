<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<style>
@font-face { 
	font-family: "elamicon"; 
	src: url("elamicon.ttf"); 
}
.elam {
	font-family: elamicon;
	unicode-bidi: bidi-override;
}


.alphabet .letter {
	text-align: center;
	height: 10em;
	vertical-align: top;
}

.elam {
	font-size: 300%;
}

.plate {
	vertical-align: top;
	padding: 0 1em;
	display: inline-block;
}

.fragment {
	font-size: 200%;
	line-height: 1em;
	display: inline-block;
}

.line {
	display: block;
	unicode-bidi: bidi-override; /* not inherited through display: block */
	border-top: 0.05em solid black;
	border-bottom: 0.05em solid black;
	margin: -0.025em 0; /* collapse the borders */
	padding: 0;
	cursor: pointer;
}

.rtl { direction: rtl; }
.ltr { direction: ltr; }
.rtl-override { direction: rtl; }
.ltr-override { direction: ltr; }

h2 {
	clear: both;
}

.alphabet {
	padding: 0;
	list-style-type: none;
}

.alphabet li {
	margin: 0.1em;
	display: inline-block;
}

.alphabet div {
	padding: 0.3em;

    color: rgba(100, 100, 100, 0.8);
    background-color: #ddd;
	text-shadow: #ddd 0.03ex 0.03ex 0.05ex, #000 0 0 0;
}

#select-direction {
	display: none; /* grace */
}

#playground {
	width: 100%;
	height: 5em;
	font-size: 200%;
}

#char-equiv {
	width: 100%;
	font-size: 150%;
}

.highlight-neighbor {
	background-color: #ffa;
}

.highlight {
	background-color: yellow;
}

.selected {
	margin: -1px;
	border: 1px dotted gray;
}

</style>
<script>
"use strict";

document.addEventListener('DOMContentLoaded', function() {
	/* Get the list of characters that are considered equivalent to the given character
	 * The returned list includes the original character.
	 */
	var char_equivs = function(char) {
		// The missing-char marker is not even equivalent to itself
		if (char === '') return [];

		var char_equivs = document.getElementById('char-equiv').value.trim();
		for (let group of char_equivs.split(',')) {
			if (group.trim().indexOf(char) >= 0) return group.split('');
		};
		return [char];
	};

	/* Create a lookup table over all characters */
	var char_map = {};
	var chars = [];

	Array.from(document.getElementsByClassName("fragment")).forEach(function(elm) {
		var last = false;
		var rm = [];

		var text_walker = document.createTreeWalker(elm, NodeFilter.SHOW_TEXT);
		while (text_walker.nextNode()) {
			var text_node = text_walker.currentNode;
			text_node.nodeValue.split('').forEach(function(char) {
				if (char.match(/\s|\u200B/)) { // 200B is the zero-width space
					text_node.parentNode.insertBefore(document.createTextNode(char), text_node);
					return;
				}
				if (char === '' || char === '') {
					if (last) {
						last.elm.appendChild(document.createTextNode(char));
					}
					return;
				}

				var elm = document.createElement('span');
				elm.appendChild(document.createTextNode(char));
				text_node.parentNode.insertBefore(elm, text_node);
				var char_info = {
					char: char,
					prev: last,
					elm: elm,
					visit_neighbors: function(distance, quest, direction) {
						if (direction) quest(this);
						if (distance > 0) {
							if ((!direction || direction === 'prev') && this.prev) this.prev.visit_neighbors(distance-1, quest, 'prev');
							if ((!direction || direction === 'next') && this.next) this.next.visit_neighbors(distance-1, quest, 'next');
						}
					}
				}
				if (last) {
					last.next = char_info;
				}
				last = char_info;

				if (char_map[char] === undefined) {
					char_map[char] = [];
				}
				char_map[char].push(char_info);
				chars.push(char_info);

				elm.addEventListener('click', function() {
					var neighboring_chars = [];
					char_info.visit_neighbors(5, function(neigh) {
						Array.prototype.push.apply(neighboring_chars, char_equivs(neigh.char));
					});

					var neighboring = neighboring_chars.join('');
					chars.forEach(function(char_info) {
						char_info.elm.classList.remove('highlight');
						char_info.elm.classList.remove('highlight-neighbor');
						char_info.elm.classList.remove('selected');
					});
					char_info.elm.classList.add('selected');
					for (let equiv_char of char_equivs(char)) {
						var occurences = char_map[equiv_char];
						if (!occurences) continue; // This happens when the equiv-chars table has chars that don't show up in the fragments
						for (let occurence of occurences) {
							occurence.elm.classList.add('highlight');
							occurence.visit_neighbors(5, function(neigh) {
								if (neighboring.indexOf(neigh.char) >= 0) {
									neigh.elm.classList.add('highlight-neighbor');
								}
							});
						};
					}
				});
			});
			rm.push(text_node);
		}

		rm.forEach(function(rmelm) {
			rmelm.parentNode.removeChild(rmelm);
		});
	});

    /* Clicks to letters in the alphabet add them to playground */
    Array.from(document.getElementsByClassName("letter")).forEach(function(letter) {
        letter.addEventListener('click', function(event) {
            var playground = document.getElementById('playground');
            playground.value = playground.value + event.target.textContent.trim();
        });
    });

	/* The font has two characters (  and ) that are used to mark the
	 * preceding character as a guess. The reason there are two of them is
	 * that the font does not see text direction (maybe this can be fixed)
	 * so the guess-mark would overlay the character on the wrong side when the
	 * direction is changed. So when changing text direction we have to replace
	 * that char as well. */
    var select_direction = document.getElementById('select-direction');
    select_direction.style.display = 'block';

    var update_direction = function() {
		var linebreaks = form.linebreaks.value === "original";
		Array.from(document.getElementsByClassName("line")).forEach(function(elm) {
			elm.style.display = linebreaks ? 'block' : 'inline';
		});

		var dir = form.direction.value;
		Array.from(document.getElementsByClassName("dir")).forEach(function(elm) {
			elm.classList.remove('rtl-override');
			elm.classList.remove('ltr-override');
			if (dir == "rtl") elm.classList.add('rtl-override');
			if (dir == "ltr") elm.classList.add('ltr-override');

			var effectiveDir = dir || (elm.classList.contains('rtl') ? 'rtl' : 'ltr');
			var wrongDir = (effectiveDir === 'ltr' ? //g : //g);
			var rightDir = (effectiveDir === 'ltr' ? '' : '')
			var textWalker = document.createTreeWalker(elm, NodeFilter.SHOW_TEXT);
			while (textWalker.nextNode()) {
				var textNode = textWalker.currentNode;
				textNode.nodeValue = textNode.nodeValue.replace(wrongDir, rightDir);
			}

			/* special case for the textarea */
			if (elm.value) elm.value = elm.value.replace(wrongDir, rightDir);
		});
    };

    var form = select_direction.children[0];
    form.addEventListener('change', update_direction);
    update_direction();
});
</script>
</head>
<body>
<h1>Elamische Zeichensammlung</h1>

<h2>Die Buchstaben</h2>
<ol class="alphabet dir ltr">
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
		<div class="syl">na</div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
    <li class="letter">
        <div class="elam"></div>
    </li>
    <li class="letter">
        <div class="elam"></div>
    </li>
	<li class="letter">
		<div class="elam"></div>
		<div class="syl">uk (?)</div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
    <li class="letter">
        <div class="elam"></div>
		<div class="name">NAP</div>
    </li>
	<li class="letter">
		<div class="elam"></div>
		<div class="name">NAP</div>
	</li>
	<li class="letter">
		<div class="elam"></div>
		<div class="syl">en (?)</div>
		<div class="syl">im (?)</div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
    <li class="letter">
        <div class="elam"></div>
    </li>
	<li class="letter">
		<div class="elam"></div>
		<div class="syl">šu</div>
	</li>
	<li class="letter">
		<div class="elam"></div>
		<div class="syl">ša (?)</div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
		<div class="syl">in</div>
	</li>
	<li class="letter">
		<div class="elam"></div>
		<div class="syl">ki</div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
		<div class="syl">iš (?)</div>
		<div class="syl">uš (?)</div>
	</li>
	<li class="letter">
		<div class="elam"></div>
		<div class="syl">tu (?)</div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
    <li class="letter">
        <div class="elam"></div>
    </li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
		<div class="syl">hu (?)</div>
	</li>
	<li class="letter">
		<div class="elam"></div>
		<div class="syl">me (?)</div>
	</li>
    <li class="letter">
        <div class="elam"></div>
    </li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
    <li class="letter">
        <div class="elam"></div>
    </li>
    <li class="letter">
        <div class="elam"></div>
		<div class="syl">ši</div>
    </li>
    <li class="letter">
        <div class="elam"></div>
		<div class="syl">še (?)</div>
		<div class="syl">si (?)</div>
    </li>
    <li class="letter">
        <div class="elam"></div>
		<div class="syl">ak</div>
		<div class="syl">ik</div>
    </li>
    <li class="letter">
        <div class="elam"></div>
    </li>
    <li class="letter">
        <div class="elam"></div>
    </li>
    <li class="letter">
        <div class="elam"></div>
        <div class="syl">hal (?)</div>
    </li>
    <li class="letter">
        <div class="elam"></div>
    </li>
    <li class="letter">
        <div class="elam"></div>
    </li>
    <li class="letter">
        <div class="elam"></div>
		<div class="syl">ú (?)</div>
    </li>
    <li class="letter">
        <div class="elam"></div>
		<div class="syl">ni (?)</div>
    </li>
    <li class="letter">
        <div class="elam"></div>
    </li>
    <li class="letter">
        <div class="elam"></div>
    </li>
    <li class="letter">
        <div class="elam"></div>
    </li>
    <li class="letter">
        <div class="elam"></div>
		<div class="syl">piš (?)</div>
    </li>
    <li class="letter">
        <div class="elam"></div>
    </li>
</ol>

<h2>Spezielle Zeichen</h2>
<dl class="dir ltr">
	<dt class="letter elam"></dt>
	<dd>Platzhalter für unbekannte Zeichen.</dd>

	<dt class="letter elam">&nbsp;&nbsp;</dt>
	<dd>Dieses Zeichen kann angefügt werden um ein anderes Zeichen als schlecht lesbar zu markieren.</dd>
</dl>


<h2>Spielplatz</h2>
Wenn du oben auf einen Buchstaben klickst wird er hier angefügt.
<textarea class="elam dir ltr" id="playground"></textarea>

<h2>Einstellungen</h2>

<div id="select-direction">
    <form>
        <label>
            Schreibrichtung
            <select name="direction">
                <option value="" selected>urpsrünglich ⇔</option>
                <option value="ltr">von links ⇒ nach rechts</option>
                <option value="rtl">nach links ⇐ von rechts</option>
            </select>
        </label>
        <br>
        <label>
            Zeilenumbrüche
            <select name="linebreaks">
                <option value="original" selected>wie original</option>
                <option value="remove">entfernen</option>
            </select>
        </label>
    </form>
</div>
<br>
<label>
Diese Zeichen werden als gleichwertig interpretiert:
<input class="elam dir ltr" id="char-equiv" value=", , , , , , , , " size="40"> (die Gruppen sind mit Kommas getrennt)
</label>


<h2>Textfragmente</h2>
<div class="dir">
<div class="plate">
<h3>A</h3>
<div class="fragment elam dir rtl">
	<span class="line">&#x200b;</span>
	<span class="line">&#x200b;</span>
	<span class="line">&#x200b;</span>
	<span class="line">&#x200b;</span>
	<span class="line">&#x200b;</span>
</div>
</div>

<div class="plate">
<h3>B</h3>
<div class="fragment elam dir ltr">
	<span class="line">&#x200b;</span>
	<span class="line">&#x200b;</span>
	<span class="line">&#x200b;</span>
</div>
</div>

<div class="plate">
<h3>C</h3>
<div class="fragment elam dir rtl">
	<span class="line">&#x200b;</span>
	<span class="line">&#x200b;</span>
	<span class="line">&#x200b;</span>
	<span class="line">&#x200b;</span>
</div>
</div>

<div class="plate">
<h3>E</h3>
<div class="fragment elam dir ltr">
	<span class="line">&#x200b;</span>
	<span class="line">&#x200b;</span>
	<span class="line">&#x200b;</span>
	<span class="line">&#x200b;</span>
</div>
</div>

<div class="plate">
<h3>Q</h3>
<div class="fragment elam dir ltr">
    <span class="line">
    &#x200b;&#x200b;&#x200b;&#x200b;
    </span>
</div>
</div>

<div class="plate">
<h3>neuE</h3>
<div class="fragment elam dir rtl">
	<span class="line">XXXXXXXXXXXX</span>
    <span class="line">XXXXXXXXX</span>
    <span class="line">XXXXXXX</span>
    <span class="line">XXXXXXXXX</span>
    <span class="line">XXXXXXXXXX</span>
    <span class="line">XXXXXX</span>
    <span class="line">XXXXXXXXXX</span>
    <span class="line">XXXXXXXXXX</span>
    <span class="line">XXXXXXXXXXXX</span>
</div>
</div>
</div>
</body>
</html>
