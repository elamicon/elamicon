<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<style>
@font-face { 
	font-family: "elamicon"; 
	src: url("elamicon.ttf"); 
}
.elam {
	font-family: elamicon;
	unicode-bidi: bidi-override;
}

.letter {
	font-size: 300%;
}

.plate {
	vertical-align: top;
	padding: 0 1em;
	display: inline-block;
}

.fragment {
	font-size: 200%;
	line-height: 1.05em;
	display: inline-block;
}

.line {
	border-top: 0.05em solid black;
	border-bottom: 0.05em solid black;
}

.rtl { direction: rtl; }
.ltr { direction: ltr; }
.rtl-override { direction: rtl; }
.ltr-override { direction: ltr; }

h2 {
	clear: both;
}

.alphabet {
	padding: 0;
	list-style-type: none;
}

.alphabet li {
	margin: 0.1em;
	display: inline-block;
}

.alphabet div {
	padding: 0.3em;

    color: rgba(100, 100, 100, 0.8);
    background-color: #ddd;
	text-shadow: #ddd 0.03ex 0.03ex 0.05ex, #000 0 0 0;
}

#select-direction {
	display: none; /* grace */
}

#playground {
	width: 100%;
	height: 5em;
	font-size: 200%;
}

.highlight {
	background-color: yellow;
}

.highlight-neighbor {
	background-color: #ffa;
}

</style>
<script>
"use strict";

document.addEventListener('DOMContentLoaded', function() {
	/* Create a lookup table over all characters */
	var char_map = {};
	var chars = [];

	Array.from(document.getElementsByClassName("elam")).forEach(function(elm) {
		var last = false;
		var rm = [];

		var text_walker = document.createTreeWalker(elm, NodeFilter.SHOW_TEXT);
		while (text_walker.nextNode()) {
			var text_node = text_walker.currentNode;
			text_node.nodeValue.split('').forEach(function(char) {
				if (char === '' || char === '') {
					if (last) {
						last.elm.appendChild(document.createTextNode(char));
						return;
					}
				}

				var elm = document.createElement('span');
				elm.appendChild(document.createTextNode(char));
				text_node.parentNode.insertBefore(elm, text_node);
				var char_info = {
					char: char,
					prev: last,
					elm: elm,
					visit_neighbors: function(distance, quest, direction) {
						if (direction) quest(this);
						if (distance > 0) {
							if ((!direction || direction === 'prev') && this.prev) this.prev.visit_neighbors(distance-1, quest, 'prev');
							if ((!direction || direction === 'next') && this.next) this.next.visit_neighbors(distance-1, quest, 'next');
						}
					}
				}
				if (last) {
					last.next = char_info;
				}
				last = char_info;

				if (char_map[char] === undefined) {
					char_map[char] = [];
				}
				char_map[char].push(char_info);
				chars.push(char_info);

				elm.addEventListener('click', function() {
					var neighboring_chars = [];
					char_info.visit_neighbors(3, function(neigh) {
						neighboring_chars.push(neigh.char);
					});

					var neighboring = neighboring_chars.join('');
					chars.forEach(function(char_info) {
						char_info.elm.classList.remove('highlight');
						char_info.elm.classList.remove('highlight-neighbor');
					});
					char_map[char].forEach(function(neigh_info) {
						neigh_info.elm.classList.add('highlight')
						neigh_info.visit_neighbors(3, function(neigh) {
							if (neighboring.indexOf(neigh.char) >= 0) {
								neigh.elm.classList.add('highlight-neighbor');
							}
						});
					});
				});
			});
			rm.push(text_node);
		}

		rm.forEach(function(rmelm) {
			rmelm.parentNode.removeChild(rmelm);
		});
	});

    /* Clicks to letters in the alphabet add them to playground */
    Array.from(document.getElementsByClassName("letter")).forEach(function(letter) {
        letter.addEventListener('click', function(event) {
            var playground = document.getElementById('playground');
            playground.value = playground.value + event.target.textContent.trim();
        });
    });

	/* The font has two characters (  and ) that are used to mark the
	 * preceding character as a guess. The reason there are two of them is
	 * that the font does not see text direction (maybe this can be fixed)
	 * so the guess-mark would overlay the character on the wrong side when the
	 * direction is changed. So when changing text direction we have to replace
	 * that char as well. */
    var select_direction = document.getElementById('select-direction');
    select_direction.style.display = 'block';

    var update_direction = function() {
		var dir = form.direction.value;
		Array.from(document.getElementsByClassName("dir")).forEach(function(elm) {
			elm.classList.remove('rtl-override');
			elm.classList.remove('ltr-override');
			if (dir == "rtl") elm.classList.add('rtl-override');
			if (dir == "ltr") elm.classList.add('ltr-override');

			var effectiveDir = dir || (elm.classList.contains('rtl') ? 'rtl' : 'ltr');
			var wrongDir = (effectiveDir === 'ltr' ? //g : //g);
			var rightDir = (effectiveDir === 'ltr' ? '' : '')
			var textWalker = document.createTreeWalker(elm, NodeFilter.SHOW_TEXT);
			while (textWalker.nextNode()) {
				var textNode = textWalker.currentNode;
				textNode.nodeValue = textNode.nodeValue.replace(wrongDir, rightDir);
			}

			/* special case for the textarea */
			if (elm.value) elm.value = elm.value.replace(wrongDir, rightDir);
		});
    };

    var form = select_direction.children[0];
    form.addEventListener('change', update_direction);
    update_direction();
});
</script>
</head>
<body>
<h1>Elamische Zeichensammlung</h1>

<div id="select-direction">
	<form>
		<label>
			Schreibrichtung
			<select name="direction">
				<option value="" selected>urpsrünglich ⇔</option>
				<option value="ltr">von links ⇒ nach rechts</option>
				<option value="rtl">nach links ⇐ von rechts</option>
			</select>
		</label>
	</form>
</div>

<h2>Die Buchstaben</h2>
<ol class="alphabet dir ltr">
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
    <li class="letter">
        <div class="elam"></div>
    </li>
    <li class="letter">
        <div class="elam"></div>
    </li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
    <li class="letter">
        <div class="elam"></div>
    </li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
    <li class="letter">
        <div class="elam"></div>
    </li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
    <li class="letter">
        <div class="elam"></div>
    </li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
	<li class="letter">
		<div class="elam"></div>
	</li>
    <li class="letter">
        <div class="elam"></div>
    </li>
    <li class="letter">
        <div class="elam"></div>
    </li>
    <li class="letter">
        <div class="elam"></div>
    </li>
    <li class="letter">
        <div class="elam"></div>
    </li>
    <li class="letter">
        <div class="elam"></div>
    </li>
    <li class="letter">
        <div class="elam"></div>
    </li>
    <li class="letter">
        <div class="elam"></div>
    </li>
    <li class="letter">
        <div class="elam"></div>
    </li>
    <li class="letter">
        <div class="elam"></div>
    </li>
    <li class="letter">
        <div class="elam"></div>
    </li>
    <li class="letter">
        <div class="elam"></div>
    </li>
    <li class="letter">
        <div class="elam"></div>
    </li>
    <li class="letter">
        <div class="elam"></div>
    </li>
    <li class="letter">
        <div class="elam"></div>
    </li>
    <li class="letter">
        <div class="elam"></div>
    </li>
</ol>

<h2>Spezielle Zeichen</h2>
<dl class="alphabet dir ltr">

	<dt class="letter elam"></dt>
	<dd>Platzhalter für unbekannte Zeichen.</dd>

	<dt class="letter elam">&nbsp;&nbsp;</dt>
	<dd>Dieses Zeichen kann angefügt werden um ein anderes Zeichen als schlecht lesbar zu markieren.</dd>
</dl>


<h2>Spielplatz</h2>
Wenn du oben auf einen Buchstaben klickst wird er hier angefügt.
<textarea class="elam dir ltr" id="playground">
 
</textarea>



<h2>Textfragmente</h2>
<div class="dir">
<div class="plate">
<h3>A</h3>
<div class="fragment elam dir rtl">
	<span class="line"></span><br>
	<span class="line"></span><br>
	<span class="line"></span><br>
	<span class="line"><span><br>
	<span class="line"></span>
</div>
</div>

<div class="plate">
<h3>B</h3>
<div class="fragment elam dir ltr">
	<span class="line"><span><br>
	<span class="line"><span><br>
	<span class="line"></span><br>
</div>
</div>

<div class="plate">
<h3>C</h3>
<div class="fragment elam dir rtl">
	<span class="line"><span><br>
	<span class="line"><span><br>
	<span class="line"><span><br>
	<span class="line"><span><br>
</div>
</div>

<div class="plate">
<h3>Q</h3>
<div class="fragment elam dir ltr">
	<span class="line">
	&#x200b;&#x200b;&#x200b;&#x200b;
	</span>
</div>
</div>
</div>
</body>
</html>
